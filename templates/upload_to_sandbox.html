<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  <meta name="renderer" content="webkit|ie-comp|ie-stand">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no" />
  <meta http-equiv="Cache-Control" content="no-siteapp" />
  <link rel="stylesheet" type="text/css" href="/static/static/h-ui/css/H-ui.min.css" />
  <link rel="stylesheet" type="text/css" href="/static/static/h-ui.admin.pro/css/h-ui.admin.pro.min.css" />
  <link rel="stylesheet" type="text/css" href="/static/lib/Hui-iconfont/1.0.8/iconfont.css" />
  <link rel="stylesheet" type="text/css" href="/static/static/h-ui.admin.pro/skin/default/skin.css" id="skin" />
  <link rel="stylesheet" type="text/css" href="/static/static/business/css/style.css" />
  <title>数据文档上传</title>
{#     <style>#}
{#    .upload-wrapper {#}
{#      padding: 60px 20px;#}
{#      min-height: 1000px;#}
{#    }#}
{#    .upload-container {#}
{#      max-width: 1280px;#}
{#      margin: auto;#}
{#      background: #fff;#}
{#      border-radius: 12px;#}
{#      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);#}
{#      padding: 80px 120px 150px 120px;#}
{#    }#}
{#    .upload-container h3 {#}
{#      text-align: center;#}
{#      font-size: 30px;#}
{#      margin-bottom: 60px;#}
{#    }#}
{#    .form-group {#}
{#      display: flex;#}
{#      align-items: center;#}
{#      justify-content: space-between;#}
{#      margin-bottom: 45px;#}
{#    }#}
{#    .form-group label {#}
{#      font-weight: bold;#}
{#      font-size: 18px;#}
{#      width: 320px;#}
{#      text-align: right;#}
{#      margin-right: 80px;#}
{#    }#}
{#    .form-group input[type="text"],#}
{#    .form-group input[type="file"] {#}
{#      flex: 1;#}
{#      padding: 16px;#}
{#      border: 1px solid #ccc;#}
{#      border-radius: 8px;#}
{#      font-size: 16px;#}
{#    }#}
{#    .btn-upload, .btn-encrypt {#}
{#      display: flex;#}
{#      justify-content: center;#}
{#      align-items: center;#}
{#      width: 100%;#}
{#      padding: 24px;#}
{#      color: white;#}
{#      font-size: 22px;#}
{#      font-weight: bold;#}
{#      border: none;#}
{#      border-radius: 12px;#}
{#      cursor: pointer;#}
{#      text-align: center;#}
{#      margin-bottom: 30px;#}
{#    }#}
    <style>
    .upload-wrapper {
      padding: 60px 20px;
      min-height: 1000px;
    }
    .upload-container {
      max-width: 1280px;
      margin: auto;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
      padding: 80px 120px 150px 120px;
    }
    .upload-container h3 {
      text-align: center;
      font-size: 30px;
      margin-bottom: 60px;
    }
    .form-group {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 45px;
    }
    .form-group label {
      font-weight: bold;
      font-size: 18px;
      width: 320px;
      text-align: right;
      margin-right: 80px;
    }
    .form-group input[type="text"],
    .form-group input[type="file"] {
      flex: 1;
      padding: 16px;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 16px;
    }
    .btn-upload, .btn-encrypt, .btn-export {
      display: flex;
      justify-content: center;
      align-items: center;
      width: 100%;
      padding: 24px;
      color: white;
      font-size: 22px;
      font-weight: bold;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      text-align: center;
      margin-bottom: 30px;
    }
    .btn-upload {
      background-color: #409EFF;
    }
    .btn-upload:hover {
      background-color: #66b1ff;
    }
    .btn-encrypt {
      background-color: #67C23A;
    }
    .btn-encrypt:hover {
      background-color: #85ce61;
    }
    .btn-export {
      background-color: #E6A23C;
    }
    .btn-export:hover {
      background-color: #f3b664;
    }
  </style>
    .btn-upload {
      background-color: #409EFF;
    }
    .btn-upload:hover {
      background-color: #66b1ff;
    }
    .btn-encrypt {
      background-color: #67C23A;
    }
    .btn-encrypt:hover {
      background-color: #85ce61;
    }
  </style>
</head>
<body>
  <!-- 左侧菜单栏 -->
  <aside class="Hui-admin-aside-wrapper">
    <div class="Hui-admin-logo-wrapper">
      <a class="logo navbar-logo" href="/aboutHui.shtml">
        <i class="va-m iconpic global-logo"></i>
        <span class="va-m">可信数据空间</span>
      </a>
    </div>
    <div class="Hui-admin-menu-dropdown bk_2">
      <dl class="Hui-menu">
        <dt class="Hui-menu-title selected"><i class="Hui-iconfont">&#xe60d;</i> 用户管理<i class="Hui-iconfont Hui-admin-menu-dropdown-arrow">&#xe6d5;</i></dt>
        <dd class="Hui-menu-item" style="display:block">
          <ul>
            <li><a href="http://127.0.0.1:8000/user-list/" title="用户管理">用户管理</a></li>
          </ul>
        </dd>
      </dl>
      <dl class="Hui-menu">
        <dt class="Hui-menu-title selected"><i class="Hui-iconfont">&#xe60d;</i> 模型训练管理<i class="Hui-iconfont Hui-admin-menu-dropdown-arrow">&#xe6d5;</i></dt>
        <dd class="Hui-menu-item" style="display:block">
          <ul>
            <li><a href="http://127.0.0.1:8000/model-list/" title="模型列表">模型列表</a></li>
            <li><a href="http://127.0.0.1:8000/sample-alignment/" title="样本对齐情况">样本对齐情况</a></li>
            <li><a href="http://127.0.0.1:8000/train-model/" title="模型训练结果查看">模型训练结果查看</a></li>
          </ul>
        </dd>
      </dl>
      <dl class="Hui-menu">
        <dt class="Hui-menu-title selected"><i class="Hui-iconfont">&#xe60d;</i> 模型应用<i class="Hui-iconfont Hui-admin-menu-dropdown-arrow">&#xe6d5;</i></dt>
        <dd class="Hui-menu-item" style="display:block">
          <ul>
            <li><a href="http://127.0.0.1:8000/application_model-main/" title="模型使用">模型使用</a></li>
            <li><a href="http://127.0.0.1:8000/application_result/" title="模型应用结果">模型应用结果</a></li>
          </ul>
        </dd>
      </dl>
      <dl class="Hui-menu">
        <dt class="Hui-menu-title selected"><i class="Hui-iconfont">&#xe60d;</i> 数据安全共享方法<i class="Hui-iconfont Hui-admin-menu-dropdown-arrow">&#xe6d5;</i></dt>
        <dd class="Hui-menu-item" style="display:block">
          <ul>
            <li><a href="http://127.0.0.1:8000/wb-interface/" title="数据接口">数据接口</a></li>
            <li><a href="http://127.0.0.1:8000/sjsx-interface/" title="数据沙箱">数据沙箱</a></li>
            <li><a href="http://127.0.0.1:8000/index/" title="隐私计算">隐私计算</a></li>
            <li><a href="http://127.0.0.1:8000/mutiindex/" title="密文计算">密文计算</a></li>
          </ul>
        </dd>
      </dl>
    </div>
  </aside>

  <!-- 顶部导航栏 -->
  <div class="Hui-admin-dislpayArrow">
    <a href="javascript:void(0);" onClick="displaynavbar(this)">
      <i class="Hui-iconfont Hui-iconfont-left">&#xe6d4;</i>
      <i class="Hui-iconfont Hui-iconfont-right">&#xe6d7;</i>
    </a>
  </div>
  <header class="Hui-navbar"></header>

  <!-- 上传表单内容 -->
  <section class="Hui-admin-article-wrapper upload-wrapper">
  <div class="upload-container">
    <h3>📄 数据文档上传</h3>
    <form id="uploadForm" enctype="multipart/form-data">
      <div class="form-group">
        <label>🧱 当前选中沙箱路径：</label>
        <input type="text" id="sandboxPath" name="sandbox_path" readonly>
      </div>
      <div class="form-group">
        <label>📂 选择要上传的文件：</label>
        <input type="file" name="file" id="fileInput">
      </div>
      <div class="form-group">
        <label>📐 文档规格说明（自动填写）：</label>
        <input type="text" name="doc_spec" id="docSpecInput" placeholder="如：CSV格式，含ID、时间、数值字段">
      </div>
      <button type="button" class="btn-encrypt" onclick="encryptData()">
        🔐 对数据进行加密处理
      </button>
      <button type="button" class="btn-upload" onclick="submitUpload()">
        🔒 将数据封存到沙箱
      </button>
        <div class="form-group" id="exportArea" style="display: none;">
          <button type="button" class="btn-export" onclick="exportSandbox()">
            📦 封存后导出沙箱
          </button>
        </div>
    </form>
  </div>
</section>
<script>
  window.onload = function () {
  const path = sessionStorage.getItem("currentSandboxPath");
  const pathInput = document.getElementById("sandboxPath");
  if (pathInput) {
    pathInput.value = path || "<未选择路径>";
  }
};

// ✅ 点击“对数据进行加密处理”按钮时，只展示 CSV 行列数，不修改文件
function encryptData() {
  const fileInput = document.getElementById("fileInput");
  const docSpecInput = document.getElementById("docSpecInput");

  if (!fileInput || fileInput.files.length === 0) {
    alert("请先选择文件");
    return;
  }

  const file = fileInput.files[0];
  const reader = new FileReader();

  if (file.name.endsWith(".csv")) {
    reader.onload = function (e) {
      const text = e.target.result;
      const lines = text.trim().split(/\r?\n/);
      const rowCount = lines.length;
      const colCount = lines[0]?.split(',').length || 0;

      // ✅ 仅展示行列数，不做 base64、不替换上传文件
      alert(`📄 CSV文档规格：共 ${rowCount} 行，${colCount} 列`);
      if (docSpecInput) {
        docSpecInput.value = `CSV格式，约${rowCount}行${colCount}列`;
      }
    };
    reader.readAsText(file);
  } else {
    alert("目前仅支持自动识别 CSV 文件行列数");
    if (docSpecInput) {
      docSpecInput.value = "非CSV格式，字段信息请手动填写";
    }
  }
}

function submitUpload() {
  const fileInput = document.getElementById("fileInput");
  const sandboxPath = document.getElementById("sandboxPath").value;

  if (!fileInput.files.length || !sandboxPath || sandboxPath.includes("未选择")) {
    alert("❗ 缺少文件或沙箱路径");
    return;
  }

  // 使用输入框中提供的路径作为容器名
  const containerName = "sandbox_" + sandboxPath
  .replace(/^https?:\/\//, "")  // 去掉 http://
  .replace(/\./g, "_")          // 替换点
  .replace(/\//g, "_");         // 替换斜杠 ✅ 必须加这一句！


  console.log("📦 使用路径构造容器名：", containerName);

  const formData = new FormData();
  formData.append("file", fileInput.files[0]);
  formData.append("sandbox_path", containerName);

  fetch("http://127.0.0.1:5001/api/uploadToSandbox", {
    method: "POST",
    body: formData
  })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        alert("✅ 上传成功！");
        fileInput.value = "";
        document.getElementById("exportArea").style.display = "block";
        currentContainerName = containerName; // 绑定导出按钮用
      } else {
        alert("❌ 上传失败：" + data.message);
      }
    })
    .catch(err => {
      console.error("❌ 上传出错：", err);
      alert("❌ 上传请求失败");
    });
}

function exportSandbox() {
  if (!currentContainerName) {
    alert("❗ 未知沙箱名，无法导出");
    return;
  }

  fetch("http://127.0.0.1:5001/api/exportSandbox", {
    method: "POST",
    headers: {
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      container_name: currentContainerName // 例如：sandbox_202_151_254_253_shaxiang215
    })
  })
    .then(res => {
      if (!res.ok) {
        throw new Error("后端返回失败");
      }
      return res.blob(); // 获取 tar.gz
    })
    .then(blob => {
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;

      // 提取简洁后缀名用于导出包名，例如 encrypted_shaxiang215.csv
      const shortName = currentContainerName.split("_").slice(-1)[0];
      a.download = `encrypted_${shortName}_sandbox.tar.gz`;

      document.body.appendChild(a);
      a.click();
      a.remove();
      window.URL.revokeObjectURL(url);

      alert("✅ 沙箱封存导出成功！");
    })
    .catch(err => {
      console.error("❌ 导出失败：", err);
      alert("❌ 沙箱导出失败：" + err.message);
    });
}



</script>
</body>
</html>
<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  <meta name="renderer" content="webkit|ie-comp|ie-stand">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no" />
  <meta http-equiv="Cache-Control" content="no-siteapp" />
  <link rel="stylesheet" type="text/css" href="/static/static/h-ui/css/H-ui.min.css" />
  <link rel="stylesheet" type="text/css" href="/static/static/h-ui.admin.pro/css/h-ui.admin.pro.min.css" />
  <link rel="stylesheet" type="text/css" href="/static/lib/Hui-iconfont/1.0.8/iconfont.css" />
  <link rel="stylesheet" type="text/css" href="/static/static/h-ui.admin.pro/skin/default/skin.css" id="skin" />
  <link rel="stylesheet" type="text/css" href="/static/static/business/css/style.css" />
  <title>æ•°æ®æ–‡æ¡£ä¸Šä¼ </title>
{#     <style>#}
{#    .upload-wrapper {#}
{#      padding: 60px 20px;#}
{#      min-height: 1000px;#}
{#    }#}
{#    .upload-container {#}
{#      max-width: 1280px;#}
{#      margin: auto;#}
{#      background: #fff;#}
{#      border-radius: 12px;#}
{#      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);#}
{#      padding: 80px 120px 150px 120px;#}
{#    }#}
{#    .upload-container h3 {#}
{#      text-align: center;#}
{#      font-size: 30px;#}
{#      margin-bottom: 60px;#}
{#    }#}
{#    .form-group {#}
{#      display: flex;#}
{#      align-items: center;#}
{#      justify-content: space-between;#}
{#      margin-bottom: 45px;#}
{#    }#}
{#    .form-group label {#}
{#      font-weight: bold;#}
{#      font-size: 18px;#}
{#      width: 320px;#}
{#      text-align: right;#}
{#      margin-right: 80px;#}
{#    }#}
{#    .form-group input[type="text"],#}
{#    .form-group input[type="file"] {#}
{#      flex: 1;#}
{#      padding: 16px;#}
{#      border: 1px solid #ccc;#}
{#      border-radius: 8px;#}
{#      font-size: 16px;#}
{#    }#}
{#    .btn-upload, .btn-encrypt {#}
{#      display: flex;#}
{#      justify-content: center;#}
{#      align-items: center;#}
{#      width: 100%;#}
{#      padding: 24px;#}
{#      color: white;#}
{#      font-size: 22px;#}
{#      font-weight: bold;#}
{#      border: none;#}
{#      border-radius: 12px;#}
{#      cursor: pointer;#}
{#      text-align: center;#}
{#      margin-bottom: 30px;#}
{#    }#}
    <style>
    .upload-wrapper {
      padding: 60px 20px;
      min-height: 1000px;
    }
    .upload-container {
      max-width: 1280px;
      margin: auto;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
      padding: 80px 120px 150px 120px;
    }
    .upload-container h3 {
      text-align: center;
      font-size: 30px;
      margin-bottom: 60px;
    }
    .form-group {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 45px;
    }
    .form-group label {
      font-weight: bold;
      font-size: 18px;
      width: 320px;
      text-align: right;
      margin-right: 80px;
    }
    .form-group input[type="text"],
    .form-group input[type="file"] {
      flex: 1;
      padding: 16px;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 16px;
    }
    .btn-upload, .btn-encrypt, .btn-export {
      display: flex;
      justify-content: center;
      align-items: center;
      width: 100%;
      padding: 24px;
      color: white;
      font-size: 22px;
      font-weight: bold;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      text-align: center;
      margin-bottom: 30px;
    }
    .btn-upload {
      background-color: #409EFF;
    }
    .btn-upload:hover {
      background-color: #66b1ff;
    }
    .btn-encrypt {
      background-color: #67C23A;
    }
    .btn-encrypt:hover {
      background-color: #85ce61;
    }
    .btn-export {
      background-color: #E6A23C;
    }
    .btn-export:hover {
      background-color: #f3b664;
    }
  </style>
    .btn-upload {
      background-color: #409EFF;
    }
    .btn-upload:hover {
      background-color: #66b1ff;
    }
    .btn-encrypt {
      background-color: #67C23A;
    }
    .btn-encrypt:hover {
      background-color: #85ce61;
    }
  </style>
</head>
<body>
  <!-- å·¦ä¾§èœå•æ  -->
  <style>
    #menu-guest .Hui-menu-title,
    #menu-guest .Hui-menu-item a {
        color: #FFFFFF !important;  /* äº®ç™½è‰² */
        text-shadow: 0 1px 2px rgba(0,0,0,0.2); /* å¢åŠ æ–‡å­—å¯¹æ¯”åº¦ */
    }

    #menu-data-confirmation .Hui-menu-title,
    #menu-data-confirmation .Hui-menu-item a {
        color: #FFFFFF !important;  /* äº®ç™½è‰² */
        text-shadow: 0 1px 2px rgba(0,0,0,0.2); /* å¢åŠ æ–‡å­—å¯¹æ¯”åº¦ */
    }
    </style>

	<!--_menu ä½œä¸ºå…¬å…±æ¨¡ç‰ˆåˆ†ç¦»å‡ºå»-->
	<aside class="Hui-admin-aside-wrapper">
		<div class="Hui-admin-logo-wrapper">
			<a class="logo navbar-logo" href="/aboutHui.shtml">
				<i class="va-m iconpic global-logo"></i>
				<span class="va-m">å¯ä¿¡æ•°æ®ç©ºé—´</span>
			</a>
		</div>
		<div class="Hui-admin-menu-dropdown bk_2">
            <dl id="menu-guest" class="Hui-menu">
				<dt class="Hui-menu-title selected"><i class="Hui-iconfont">&#xe60d;</i> ç”¨æˆ·ç®¡ç†<i class="Hui-iconfont Hui-admin-menu-dropdown-arrow">&#xe6d5;</i></dt>
				<dd class="Hui-menu-item" style="display:block">
					<ul>
						<li><a href="/user-list/" title="ç”¨æˆ·ç®¡ç†">ç”¨æˆ·ç®¡ç†</a></li>
					</ul>
				</dd>
			</dl>
            <dl id="menu-data-confirmation" class="Hui-menu">
              <dt class="Hui-menu-title"><i class="Hui-iconfont">&#xe616;</i> æ•°æ®ç¡®æƒ<i class="Hui-iconfont Hui-admin-menu-dropdown-arrow">&#xe6d5;</i></dt>
              <dd class="Hui-menu-item" style="display:block">
                <ul>
                  <li><a href="/data-confirmation/" title="æ•°æ®ç¡®æƒ">æ•°æ®ç¡®æƒ</a></li>
                </ul>
              </dd>
            </dl>

            <dl id="menu-guest" class="Hui-menu">
				<dt class="Hui-menu-title selected"><i class="Hui-iconfont">&#xe60d;</i> æ•°æ®èµ„äº§ç®¡ç†<i class="Hui-iconfont Hui-admin-menu-dropdown-arrow">&#xe6d5;</i></dt>
				<dd class="Hui-menu-item" style="display:block">
					<ul>
						<li><a href="/data_asset_list/" title="æ•°æ®èµ„äº§åˆ—è¡¨">æ•°æ®èµ„äº§åˆ—è¡¨</a></li>
					</ul>
				</dd>

			</dl>
             <dl id="menu-guest" class="Hui-menu">
                <dt class="Hui-menu-title selected"><i class="Hui-iconfont">&#xe60d;</i> é¡¹ç›®ä¿¡æ¯ç®¡ç†<i class="Hui-iconfont Hui-admin-menu-dropdown-arrow">&#xe6d5;</i></dt>
                <dd class="Hui-menu-item" style="display:block">
                    <ul>
                        <li><a href="/established_project/" title="å·²å»ºç«‹é¡¹ç›®">å·²å»ºç«‹é¡¹ç›®</a></li>
                    </ul>
                    <ul>
                        <li><a href="/pengding_project/" title="å¾…æ¥å—é¡¹ç›®">å¾…æ¥å—é¡¹ç›®</a></li>
                    </ul>
                </dd>
            </dl>
            <dl id="menu-guest" class="Hui-menu">
				<dt class="Hui-menu-title selected"><i class="Hui-iconfont">&#xe60d;</i> åŒºå—é“¾å­˜è¯ä¿¡æ¯ç®¡ç†<i class="Hui-iconfont Hui-admin-menu-dropdown-arrow">&#xe6d5;</i></dt>
				<dd class="Hui-menu-item" style="display:block">
					<ul>
						<li><a href="/records/" title="æ•°æ®å­˜è¯ä¿¡æ¯">æ•°æ®å­˜è¯ä¿¡æ¯</a></li>
					</ul>
				</dd>
                <dd class="Hui-menu-item" style="display:block">
					<ul>
						<li><a href="/project_notarization/" title="é¡¹ç›®å­˜è¯ä¿¡æ¯">é¡¹ç›®å­˜è¯ä¿¡æ¯</a></li>
					</ul>
				</dd>
			</dl>
            <dl id="menu-guest" class="Hui-menu">
				<dt class="Hui-menu-title selected"><i class="Hui-iconfont">&#xe60d;</i>æ•°æ®å®‰å…¨å…±äº«æ–¹æ³•<i class="Hui-iconfont Hui-admin-menu-dropdown-arrow">&#xe6d5;</i></dt>
                <dd class="Hui-menu-item" style="display:block">
					<ul>
						<li><a href="/wb-interface/" title="æ•°æ®æ¥å£">æ•°æ®æ¥å£</a></li>
					</ul>
				</dd>
                <dd class="Hui-menu-item" style="display:block">
					<ul>
						<li class="current"><a href="/sjsx-interface/" title="æ•°æ®æ²™ç®±">æ•°æ®æ²™ç®±</a></li>
					</ul>
				</dd>
				<dd class="Hui-menu-item" style="display:block">
					<ul>
						<li><a href="/guest-list/" title="éšç§è®¡ç®—">éšç§è®¡ç®—</a></li>
					</ul>
				</dd>
                <dd class="Hui-menu-item" style="display:block">
					<ul>
						<li><a href="/multguest-list/" title="å¯†æ–‡è®¡ç®—">å¯†æ–‡è®¡ç®—</a></li>
					</ul>
				</dd>
			</dl>
		</div>
	</aside>

<!--_footer ä½œä¸ºå…¬å…±æ¨¡ç‰ˆåˆ†ç¦»å‡ºå»-->
	<script type="text/javascript" src="/static/lib/jquery/1.9.1/jquery.min.js"></script>
  	<script type="text/javascript" src="/static/lib/jquery.validation/1.14.0/jquery.validate.js"></script>
	<script type="text/javascript" src="/static/lib/jquery.validation/1.14.0/validate-methods.js"></script>
	<script type="text/javascript" src="/static/lib/jquery.validation/1.14.0/messages_zh.js"></script>
  <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
  <div class="Hui-admin-dislpayArrow">
    <a href="javascript:void(0);" onClick="displaynavbar(this)">
      <i class="Hui-iconfont Hui-iconfont-left">&#xe6d4;</i>
      <i class="Hui-iconfont Hui-iconfont-right">&#xe6d7;</i>
    </a>
  </div>
  <header class="Hui-navbar"></header>

  <!-- ä¸Šä¼ è¡¨å•å†…å®¹ -->
  <section class="Hui-admin-article-wrapper upload-wrapper">
  <div class="upload-container">
    <h3>ğŸ“„ æ•°æ®æ–‡æ¡£ä¸Šä¼ </h3>
    <form id="uploadForm" enctype="multipart/form-data">
      <div class="form-group">
        <label>ğŸ§± å½“å‰é€‰ä¸­æ²™ç®±è·¯å¾„ï¼š</label>
        <input type="text" id="sandboxPath" name="sandbox_path" readonly>
      </div>
      <div class="form-group">
        <label>ğŸ“‚ é€‰æ‹©è¦ä¸Šä¼ çš„æ–‡ä»¶ï¼š</label>
        <input type="file" name="file" id="fileInput">
      </div>
      <div class="form-group">
        <label>ğŸ“ æ–‡æ¡£è§„æ ¼è¯´æ˜ï¼ˆè‡ªåŠ¨å¡«å†™ï¼‰ï¼š</label>
        <input type="text" name="doc_spec" id="docSpecInput" placeholder="å¦‚ï¼šCSVæ ¼å¼ï¼Œå«IDã€æ—¶é—´ã€æ•°å€¼å­—æ®µ">
      </div>
      <button type="button" class="btn-encrypt" onclick="encryptData()">
        ğŸ” å¯¹æ•°æ®è¿›è¡ŒåŠ å¯†å¤„ç†
      </button>
      <button type="button" class="btn-upload" onclick="submitUpload()">
        ğŸ”’ å°†æ•°æ®å°å­˜åˆ°æ²™ç®±
      </button>
        <div class="form-group" id="exportArea" style="display: none;">
          <button type="button" class="btn-export" onclick="exportSandbox()">
            ğŸ“¦ å°å­˜åå¯¼å‡ºæ²™ç®±
          </button>
        </div>
        <div class="form-group" id="linkArea" style="display: none;">
  <button type="button" class="btn-encrypt" onclick="generateReadonlyLink()">
    ğŸŒ ç”Ÿæˆåªè¯»æŸ¥çœ‹é“¾æ¥ï¼ˆç»™æ¥æ”¶æ–¹ï¼‰
  </button>
</div>

    </form>
  </div>
</section>
<script>
  window.onload = function () {
  const path = sessionStorage.getItem("currentSandboxPath");
  const zcname = sessionStorage.getItem("currentzcname");
  
  const pathInput = document.getElementById("sandboxPath");
  if (pathInput) {
    pathInput.value = path || "<æœªé€‰æ‹©è·¯å¾„>";
  }
};

// âœ… ç‚¹å‡»â€œå¯¹æ•°æ®è¿›è¡ŒåŠ å¯†å¤„ç†â€æŒ‰é’®æ—¶ï¼Œåªå±•ç¤º CSV è¡Œåˆ—æ•°ï¼Œä¸ä¿®æ”¹æ–‡ä»¶
function encryptData() {
  const fileInput = document.getElementById("fileInput");
  const docSpecInput = document.getElementById("docSpecInput");

  if (!fileInput || fileInput.files.length === 0) {
    alert("è¯·å…ˆé€‰æ‹©æ–‡ä»¶");
    return;
  }

  const file = fileInput.files[0];
  const reader = new FileReader();

  if (file.name.endsWith(".csv")) {
    reader.onload = function (e) {
      const text = e.target.result;
      const lines = text.trim().split(/\r?\n/);
      const rowCount = lines.length;
      const colCount = lines[0]?.split(',').length || 0;

      // âœ… ä»…å±•ç¤ºè¡Œåˆ—æ•°ï¼Œä¸åš base64ã€ä¸æ›¿æ¢ä¸Šä¼ æ–‡ä»¶
      alert(`ğŸ“„ CSVæ–‡æ¡£è§„æ ¼ï¼šå…± ${rowCount} è¡Œï¼Œ${colCount} åˆ—`);
      if (docSpecInput) {
        docSpecInput.value = `CSVæ ¼å¼ï¼Œçº¦${rowCount}è¡Œ${colCount}åˆ—`;
      }
    };
    reader.readAsText(file);
  } else {
    alert("ç›®å‰ä»…æ”¯æŒè‡ªåŠ¨è¯†åˆ« CSV æ–‡ä»¶è¡Œåˆ—æ•°");
    if (docSpecInput) {
      docSpecInput.value = "éCSVæ ¼å¼ï¼Œå­—æ®µä¿¡æ¯è¯·æ‰‹åŠ¨å¡«å†™";
    }
  }
}

function submitUpload() {
  const fileInput = document.getElementById("fileInput");
  const sandboxPath = document.getElementById("sandboxPath").value;

  if (!fileInput.files.length || !sandboxPath || sandboxPath.includes("æœªé€‰æ‹©")) {
    alert("â— ç¼ºå°‘æ–‡ä»¶æˆ–æ²™ç®±è·¯å¾„");
    return;
  }

  // ä½¿ç”¨è¾“å…¥æ¡†ä¸­æä¾›çš„è·¯å¾„ä½œä¸ºå®¹å™¨å
  const containerName = "sandbox_" + sandboxPath
  .replace(/^https?:\/\//, "")  // å»æ‰ http://
  .replace(/\./g, "_")          // æ›¿æ¢ç‚¹
  .replace(/\//g, "_");         // æ›¿æ¢æ–œæ  âœ… å¿…é¡»åŠ è¿™ä¸€å¥ï¼


  console.log("ğŸ“¦ ä½¿ç”¨è·¯å¾„æ„é€ å®¹å™¨åï¼š", containerName);

  const formData = new FormData();
  formData.append("file", fileInput.files[0]);
  formData.append("sandbox_path", containerName);

  fetch("http://192.168.1.132:5001/api/uploadToSandbox", {
  method: "POST",
  body: formData
})
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      alert("âœ… ä¸Šä¼ æˆåŠŸï¼");
      fileInput.value = "";
      document.getElementById("exportArea").style.display = "block";
      document.getElementById("linkArea").style.display = "block";
      currentContainerName = containerName;

      // âœ… âš ï¸ æŠŠ AJAX è¯·æ±‚ç§»è¿›æ¥ï¼
      const zcname = sessionStorage.getItem("currentzcname");
      console.log("å‡†å¤‡å‘é€çš„ zcname:", zcname);

      $.ajax({
        type: "post",
        url: "/createinterfacesx/",
        dataType: "json",
        data: { zcname: zcname },
        success: function (res) {
          console.log("åç«¯è¿”å›ç»“æœ res:", res);
          if (res.status == "0") {
            alert("æ–°å¢æˆåŠŸ,å·²é€šè¿‡åŒºå—é“¾å­˜è¯");
          } else {
            alert("å‡ºç°é”™è¯¯ï¼š" + (res.message || "æœªçŸ¥é”™è¯¯"));
          }
        },
        error: function (xhr, status, error) {
          console.error("AJAX è¯·æ±‚å¤±è´¥");
          console.error("çŠ¶æ€ç :", status);
          console.error("é”™è¯¯ä¿¡æ¯:", error);
          console.error("å“åº”ä½“:", xhr.responseText);
          alert("è¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ§åˆ¶å°æ—¥å¿—");
        },
        beforeSend: function () {
          console.log("å³å°†å‘é€ AJAX è¯·æ±‚åˆ° /createinterfacesx/");
        },
        complete: function () {
          console.log("AJAX è¯·æ±‚å·²å®Œæˆ");
        }
      });

    } else {
      alert("âŒ ä¸Šä¼ å¤±è´¥ï¼š" + data.message);
    }
  })
  .catch(err => {
    console.error("âŒ ä¸Šä¼ å‡ºé”™ï¼š", err);
    alert("âŒ ä¸Šä¼ è¯·æ±‚å¤±è´¥");
  });

  
}

function generateReadonlyLink() {
  if (!currentContainerName) {
    alert("â— å½“å‰æ— æ²™ç®±è·¯å¾„ï¼Œæ— æ³•ç”Ÿæˆé“¾æ¥");
    return;
  }

  fetch("http://192.168.1.132:5001/api/generateReadonlyLink", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ container_name: currentContainerName })
  })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        const link = data.link;
        alert("âœ… é“¾æ¥ç”ŸæˆæˆåŠŸï¼Œå¤åˆ¶ç»™æ¥æ”¶æ–¹ï¼š\n" + link);

        
        const box = document.createElement("div");
        box.style.marginTop = "30px";
        box.style.padding = "20px";
        box.style.border = "1px solid #dcdfe6";
        box.style.borderRadius = "8px";
        box.style.backgroundColor = "#f5f7fa";
        box.style.fontSize = "16px";
        box.style.color = "#606266";
        box.style.boxShadow = "0 2px 6px rgba(0,0,0,0.05)";

        box.innerHTML = `
          <p style="font-weight: bold; color: #409EFF; margin-bottom: 10px;">
            ğŸ“ åªè¯»æŸ¥çœ‹é“¾æ¥å·²ç”Ÿæˆï¼ˆæ¥æ”¶æ–¹å¯è®¿é—®ï¼‰ï¼š
          </p>
          <div style="padding: 12px; background: white; border: 1px dashed #c0c4cc; border-radius: 6px;">
            ${link}
          </div>
        `;

        document.querySelector(".upload-container").appendChild(box);

        const path = sessionStorage.getItem("currentSandboxPath");
        const link1 = data.link;

        const linkData = {
            sandbox_path: path,
            readonly_link: link1
        };

        $.ajax({
        type: "post",
        url: "/insert-readonly-link/",
        data: JSON.stringify(linkData),
        contentType: "application/json",
        dataType: "json",
        success: function(res) {
            console.log("é“¾æ¥ä¿¡æ¯æäº¤æˆåŠŸï¼š", res);
        },
        error: function(err) {
            console.log("é“¾æ¥ä¿¡æ¯æäº¤å‡ºé”™ï¼š", err);
        }
        });

      } else {
        alert("âŒ ç”Ÿæˆé“¾æ¥å¤±è´¥ï¼š" + data.message);
      }
    })
    .catch(err => {
      console.error("âŒ è¯·æ±‚å¤±è´¥ï¼š", err);
      alert("âŒ æ¥å£è¯·æ±‚å¼‚å¸¸");
    });



  
}


function exportSandbox() {
  if (!currentContainerName) {
    alert("â— æœªçŸ¥æ²™ç®±åï¼Œæ— æ³•å¯¼å‡º");
    return;
  }

  fetch("http://192.168.1.132:5001/api/exportSandbox", {
    method: "POST",
    headers: {
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      container_name: currentContainerName // ä¾‹å¦‚ï¼šsandbox_202_151_254_253_shaxiang215
    })
  })
    .then(res => {
      if (!res.ok) {
        throw new Error("åç«¯è¿”å›å¤±è´¥");
      }
      return res.blob(); // è·å– tar.gz
    })
    .then(blob => {
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;

      // æå–ç®€æ´åç¼€åç”¨äºå¯¼å‡ºåŒ…åï¼Œä¾‹å¦‚ encrypted_shaxiang215.csv
      const shortName = currentContainerName.split("_").slice(-1)[0];
      a.download = `encrypted_${shortName}_sandbox.tar.gz`;

      document.body.appendChild(a);
      a.click();
      a.remove();
      window.URL.revokeObjectURL(url);

      alert("âœ… æ²™ç®±å°å­˜å¯¼å‡ºæˆåŠŸï¼");
    })
    .catch(err => {
      console.error("âŒ å¯¼å‡ºå¤±è´¥ï¼š", err);
      alert("âŒ æ²™ç®±å¯¼å‡ºå¤±è´¥ï¼š" + err.message);
    });
}



</script>
</body>
</html>